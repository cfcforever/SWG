---
title: "about SWG and FAR"
output:
  html_notebook:
    toc: yes
    toc_depth: 3
---
This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 


```{r}
#### load packages ####
library(ncdf4)

library(stats4)
library(VGAM)
library(timeDate)

library(CDFt)

library(ggplot2)
```

Here, we concentrate on the daily average temperature over the spatial domain [48N,50N]x[01E,04E] for the period from 1979 to 2017.

# Data selection
## Predictor

We use geopotential at 500 hPa as predictor for daily temperature. 
[ERA-Interim](http://apps.ecmwf.int/datasets/data/interim-full-daily/levtype=sfc/) database is chosen for geopentential at 500 hPa.

$$\begin{array}{|c|c|c|c|}
\hline
       & \textrm{resolution} & \textrm{time range} & \textrm{spatial domain} \\
\hline
\textrm{daily geopotential 500 hPa} & 0.75 & \textrm{from 1979-01-01 to 2017-12-31} & \textrm{[22.5, 70.5] x [-80.25, 50.25]} \\
\hline
\end{array}$$

```{r, eval=FALSE}
#### load geop.nc ####
nc <- nc_open("~/Documents/LSCE/nc/geop_500.1979-2017_NA.nc")
# print(nc)
data = ncvar_get(nc, "z") 
LON = ncvar_get(nc, "longitude")
LAT = ncvar_get(nc, "latitude")
time = ncvar_get(nc, "time")
nc_close(nc)

nlon = length(LON)
nlat = length(LAT)
nt   = length(time)

## transform 3D data to 2D data
dat = data*NA; dim(dat) <- c(nt, nlat, nlon)
for (i in 1:nt){ 
  dat[i,,] = t(data[,,i]) 
}
dim(dat) = c(nt, nlat*nlon)

## weighting
pond = 1/sqrt(cos(LAT*pi/180))
scale = rep(pond, length(LON))

w_dat = dat*NA
for(pix in 1:ncol(w_dat)){
  w_dat[,pix] = dat[,pix]/scale[pix]
}
```

w_dat is prepared to calculate PCA for the use of estimation and simulation.

### PCA
```{r, eval=FALSE}
## PCA for 4 seasons
SEAS=c('DJF','MAM','JJA','SON')

## time range from 1979 to 2017
DATE_ERAI = atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

pca = prcomp(w_dat[DATE_ERAI$m%in%c(12,1,2), ], retx = T, scale = T)
search.PCAlevel(pca, 90)
PCS = as.data.frame(pca$x)
save(PCS, file = paste0("~/Documents/LSCE/SWG/t2m/geop_", SEAS[1], "_PCS.RData"))

pca = prcomp(w_dat[DATE_ERAI$m%in%c(3,4,5), ], retx = T, scale = T)
search.PCAlevel(pca, 90)
PCS = as.data.frame(pca$x)
save(PCS, file = paste0("~/Documents/LSCE/SWG/t2m/geop_", SEAS[2], "_PCS.RData"))

pca = prcomp(w_dat[DATE_ERAI$m%in%c(6,7,8), ], retx = T, scale = T)
search.PCAlevel(pca, 90)
PCS = as.data.frame(pca$x)
save(PCS, file = paste0("~/Documents/LSCE/SWG/t2m/geop_", SEAS[3], "_PCS.RData"))

pca = prcomp(w_dat[DATE_ERAI$m%in%c(9,10,11), ], retx = T, scale = T)
search.PCAlevel(pca, 90)
PCS = as.data.frame(pca$x)
save(PCS, file = paste0("~/Documents/LSCE/SWG/t2m/geop_", SEAS[4], "_PCS.RData"))
```

## Data
We use [E-OBS](https://climexp.knmi.nl/select.cgi?id=someone@somewhere&field=ensembles_05_tg) database for daily temparature.

$$\begin{array}{|c|c|c|c|}
\hline
       & \textrm{resolution} & \textrm{time range} & \textrm{spatial domain} \\
\hline
\textrm{daily temperautre} & 0.5 & \textrm{from 1950-01-01 to 2018-04-30} & \textrm{[48N,50N]x[01E,04E]} \\
\hline
\end{array}$$


```{r, eval=FALSE}
## E-OBS database for daily temperature from 1950-01-01 to 2018-04-30
time = as.Date(1:24957, origin = "1949-12-31"); nt = length(time)
range(time)

## coord_grid store the coordinates of each point
lon = seq(from = 1.25, to = 3.75, by = 0.5); nx = length(lon)
lat = seq(from = 48.25, to =  49.75, by = 0.5); ny = length(lat)
coord_grid = as.data.frame(matrix(NA, nrow = nx*ny, ncol = 2))
colnames(coord_grid) = c("lon", "lat")
coord_grid$lon = rep(lon, each = ny)
coord_grid$lat = rep(lat, n = nx)

## load temperature data of each grid point 
data = as.data.frame(matrix(NA, nrow = nt, ncol = nx*ny))
rownames(data) = time
for (k in 1:(nx*ny)){
  nc <- nc_open(paste0("~/Documents/LSCE/tmean_48_50_N_01_04_E/igridensembles_05_tg_000", coord_grid[k,1], "_0", coord_grid[k,2], "_n.nc"))
  data[,k] = ncvar_get(nc, "tg")[1:nt]
  nc_close(nc)
}


## make average over whole domain
tmean = as.data.frame(apply(data, MARGIN = 1, FUN = mean))
colnames(tmean) = c("tmean")
range(tmean)
save(tmean, file = "~/Documents/LSCE/SWG/tmean_48_50_N_01_04_E.RData")


## select the period from 1979 to 2017
tmean = tmean[which(rownames(tmean) == "1979-01-01"):which(rownames(tmean) == "2017-12-31"),]
tmean = as.data.frame(tmean)
rownames(tmean) = time[which(time=="1979-01-01"):which(time=="2017-12-31")]
save(tmean, file = "~/Documents/LSCE/SWG/tmean_48_50_N_01_04_E_1979_2017.RData")

```


# Estimation and simulation
## Estimation
By using cross-validation method

$$\begin{array}{|l|c|c|}
\textrm{Total time range} & \textrm{1979 - 2017} & \textrm{39 years} \\
\textrm{Period for estimation} & \textrm{1979 - 2004} & \textrm{26 years} \\
\textrm{Period for validation} & \textrm{2005 - 2017} & \textrm{13 years} \\
\end{array}$$

```{r, eval=FALSE}
# some common definitions for months and seasons
MON=c(12,1:11)
MON=matrix(MON,nrow=4,ncol=3,byrow=T)
SEAS=c('DJF','MAM','JJA','SON')
season=c('Winter','Spring','Summer','Fall')

# the whole DATE from 1979 to 2017
DATE_OBS = atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))
```

```{r, eval=FALSE}
# Estimation of parameters in 4 seaons
for (seas in 1:4){
  
  cat(season[seas],'\n')
  
  # DATE_ERAI as the same as DATE_OBS
  DATE_ERAI = atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))
  
  # choose for the right months for season 
  idxdates = which(DATE_ERAI['m']==MON[seas,1] | DATE_ERAI['m']==MON[seas,2] | DATE_ERAI['m']==MON[seas,3])
  
  # DATE_ERAI only in season
  DATE_ERAI = DATE_ERAI[idxdates,]
  
  # /!\ load PCS of season - VERY IMPORTANT
  load(paste("~/Documents/LSCE/SWG/t2m/geop_",SEAS[seas],"_PCS.RData",sep=""))
  PCS = PCS[,1:20]   # for 90% variance
  
  # load tmean - this is main data
  load("~/Documents/LSCE/SWG/tmean_48_50_N_01_04_E_1979_2017.RData")
  dat = tmean
  
  # number of station - here only 1
  NB_STATION = 1
  
  # chosen period for estimation
  # 1979 - 2017: 39 years
  # 1979 - 2004: 26 years for estimation 
  # 2005 - 2017: 13 years for validation
  idx_control_dates = which((DATE_ERAI['Y']>=1979) & (DATE_ERAI['Y']<=2004))
  
  # PCS in estimation years
  PCS=PCS[idx_control_dates,]
  pc_name=names(PCS)
  
  # cherche les indices de jour dans DATE_ECA qui correspondent aux dates ERAI pour la période de calibration
  idx_dates=array(0,dim=length(idx_control_dates))
  for (i in 1:length(idx_control_dates)){
    idx_dates[i]=which(((DATE_OBS['Y'])[,1]==(DATE_ERAI['Y'])[idx_control_dates[i],1])
                       & ((DATE_OBS['m'])[,1]==(DATE_ERAI['m'])[idx_control_dates[i],1])
                       & ((DATE_OBS['d'])[,1]==(DATE_ERAI['d'])[idx_control_dates[i],1]))
  } # end for i
  
  fmlatt=as.formula(paste("TT ~ ",paste(pc_name, collapse= "+")))
  fit_stations_tt <- vector("list", NB_STATION)
  
  for (i in 1:NB_STATION){
    
    temp=dat[idx_dates,i]
    
    if(length(which(is.na(temp)!=TRUE))==0){
      fit_stations_tt[[i]]=NaN
    }
    if(length(which(is.na(temp)!=TRUE))!=0){
      tt = data.frame(TT=temp,PCS)   # ncol = 1+20
      fit_stations_tt[[(i)]] = try(vgam(fmlatt ,uninormal(zero=NULL), data=tt,maxit=1000, x.arg= FALSE, y.arg= FALSE, qr.arg = FALSE),silent=T)
    }                          
    
  } # end for i NB_STATION
  
  filename=paste('~/Documents/LSCE/SWG/SWG_ERAI_ESD_tmean_',season[seas],'_cross-val.RData',sep="")
  cat(filename,'\n')
  save(fit_stations_tt,file = filename)

} # end for seas
```

## Simulation
### Simulation for mean and sd 
```{r, eval=FALSE}
# whole period from 1979 to 2017
DATE_ERAI= atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

# period for projection (2005 - 2017)
DATE_proj = atoms(timeSequence(from="2005-01-01",to="2017-12-31",by='day'))
LENGTH_proj = dim(atoms(timeSequence(from="2005-01-01",to="2017-12-31",by='day')))[1]

# for temperature, we use gaussian distribution, so mean and sd involve
mean = array(NaN,c(LENGTH_proj,1)) # matrice de probas d'occurrence
sd = array(NaN,c(LENGTH_proj,1))

DATE_OBS= atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

MON=c(12,1:11)
MON=matrix(MON,nrow=4,ncol=3,byrow=T)
SEAS=c('DJF','MAM','JJA','SON')
season=c('Winter','Spring','Summer','Fall')

for (seas in 1:4){
  # seas = 2
  cat(season[seas],'\n')
  
  DATE_ERAI= atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))
  idxdates = which(DATE_ERAI['m']==MON[seas,1] | DATE_ERAI['m']==MON[seas,2] | DATE_ERAI['m']==MON[seas,3])
  DATE_ERAI=DATE_ERAI[idxdates,]
  
  idx_proj_dates = which( (DATE_ERAI['Y']>=2005) & (DATE_ERAI['Y']<=2017) )    # 2005 - 2017
  
  load(paste("~/Documents/LSCE/SWG/t2m/geop_",SEAS[seas],"_PCS.RData",sep=""))
  
  PCS=PCS[idx_proj_dates,1:20] # Pour T
  NB_pred=dim(PCS)[2]
  
  
  # Nom du fichier sauvegardé contenant les estimations
  filename=paste('~/Documents/LSCE/SWG/SWG_ERAI_ESD_tmean_',season[seas],'_cross-val.RData',sep="")
  load(filename)
  
  tempmean = array(NaN,c(length(idx_proj_dates),length(fit_stations_tt)))
  tempsd = array(NaN,c(length(idx_proj_dates),length(fit_stations_tt)))
  
  slot=array(NA,length(fit_stations_tt))
  for (i in 1:length(fit_stations_tt)){
    slot[i]=length(slotNames(fit_stations_tt[[i]]))
  }
  
  idx=which(slot>0)
  
  for (k in idx){
    #cat(k,'\n')
    par_tt=coef(fit_stations_tt[[k]],matrix=T)
    tempsd[,k] = exp(par_tt[1,2] + as.matrix(PCS[,1:(NB_pred)])%*%as.matrix(par_tt[2:(NB_pred+1),2]))
    tempmean[,k] = par_tt[1,1] + as.matrix(PCS[,1:(NB_pred)])%*%as.matrix(par_tt[2:(NB_pred+1),1])
  } # end for k
  
  td = which(DATE_OBS$Y==2005)[1]-1
  
  mean[(idxdates[idx_proj_dates] - td),] = tempmean   ; cat(range(tempmean), "\n")
  sd[(idxdates[idx_proj_dates] - td),] = tempsd       ; cat(range(tempsd)  , "\n")
  
} # end for seas

save(sd, mean, file = "~/Documents/LSCE/SWG/tmean_mean_sd.RData")

```

### Sampling
```{r, eval=FALSE}
# load("~/Documents/LSCE/SWG/tmean_mean_sd.RData")

DATE = atoms(timeSequence(from="2005-01-01",to="2017-12-31",by='day'))

## Gaussain distribution for temperature
Sample_gaussian_temp<- function(par_tt1,par_tt2){
  a=date()
  cat(a,'\n')
  Nb_stations=dim(par_tt1)[2]
  echant=array(NaN,dim=dim(par_tt1))
  for (station in 1:Nb_stations){
    for (j in 1:(dim(par_tt1)[1])){
      echant[j,station]=rnorm(1,mean=par_tt1[j,station],sd=par_tt2[j,station])
    }
  }
  a=date()
  cat(a,'\n')
  return(echant)
}

## make 100 runs
for(i in 1:100){
  
  NUM=cbind(formatC(i, digits = 0, width = 3, format = "f", flag = "0"))
  cat('Run', NUM, '\n')
  
  Sample_temp = Sample_gaussian_temp(mean,sd)
  Sample=array(NaN,dim=dim(sd))
  Sample[,1]=Sample_temp
  
  Sample=round(Sample,digits=2)
  
  filesimu = paste('~/Documents/LSCE/SWG//SIMU_tmean/SIMU_SWG_tmean', '_run_', NUM, '.RData', sep="")
  save(Sample,DATE,file = filesimu)
  
}
```


# Diagonosis
## Distribution
```{r}
## validation period: 2005 - 2017
time = as.Date(1:4748, origin = "2004-12-31")
range(time)

## load Obs data
load("~/Documents/LSCE/SWG/tmean_48_50_N_01_04_E_1979_2017.RData")
Obs = tmean[which(rownames(tmean)=="2005-01-01"):which(rownames(tmean)=="2017-12-31"),]
plot(x = time, y = Obs)
range(Obs) # -7.878333 27.243333


## load one simulation (Sample)
load("~/Documents/LSCE/SWG/SIMU_tmean/SIMU_SWG_tmean_run_001.RData")
Sample = Sample[,1]
plot(x = time, y = Sample)
range(Sample)

# hist(Obs)
# hist(Sample)

# library(goftest)
# library(RVAideMemoire)
# CvM.test(Sample, Obs)

## qqplot
qqplot(Obs, Sample, xlab = "obs", ylab = "sim", pch = 20,
       main = "tmean", cex.main = 1.5, cex.lab = 1, 
       xlim = c(min(c(Obs, Sample)), max(c(Obs, Sample))),
       ylim = c(min(c(Obs, Sample)), max(c(Obs, Sample))))
abline(0,1,col="red")
```

[Cramér-von Mises test (two samples)](https://en.wikipedia.org/wiki/Cram%C3%A9r%E2%80%93von_Mises_criterion)
$$
\textrm{CvM} = \frac{U}{NM(N+M)} - \frac{4MN-1}{6(M+N)}
$$
where U is defined as 
$$
U = N\sum_{i=1}^{N}(r_i - i)^2 + M\sum_{j=1}^{M}(s_j - j)^2
$$

```{r}
## CramerVonMises in library(CDFt)
CramerVonMisesTwoSamples


res <- CramerVonMisesTwoSamples(Sample, Obs)
pvalue = 1/6*exp(-res)
pvalue
```


## Temporal correlation (autocorrelation)
```{r}
# load tmean
load("~/Documents/LSCE/SWG/tmean_48_50_N_01_04_E_1979_2017.RData")   

# Obs as tmean - daily mean temperature from 2005 to 2017 in the zone [48N, 50N]x[01E, 04E]
Obs = tmean[which(rownames(tmean)=="2005-01-01"):which(rownames(tmean)=="2017-12-31"),]

# NUM: number with 3 digits
k = 1 
NUM=cbind(formatC(k, digits = 0, width = 3, format = "f", flag = "0"))
  
# load one Sample (see k and NUM)
load(paste0("~/Documents/LSCE/SWG/SIMU_tmean/SIMU_SWG_tmean_run_", NUM, ".RData"))
Sample = Sample[,1]

# set number of lag
nlag = 31

# data_acf contains acf_obs and acf_sim
data_acf = as.data.frame(matrix(data = NA, nrow = 2*nlag, ncol = 3))

acf_obs = acf(Obs, plot = F, lag.max = nlag-1)
acf_obs = with(acf_obs, data.frame(lag, acf))
acf_obs = acf_obs[-1,]
acf_sim = acf(Sample, plot = F, lag.max = nlag-1)
acf_sim = with(acf_sim, data.frame(lag, acf))
acf_sim = acf_sim[-1,]
data_acf = rbind(acf_obs, acf_sim)
data_acf$type = c(rep("obs", nlag-1), rep("sim", nlag-1))

color = c("black", "red")
{
  p = ggplot(data = data_acf, mapping = aes(x = lag, y = acf))
  p = p + geom_bar(stat = "identity", aes(fill = type), position = "dodge")
  p = p + scale_fill_manual(values = color)
  p = p + xlab("day")
  p = p + ggtitle(paste0("acf - Obs vs Sample_", k))
  print(p)
}
```



# Fraction of attributable risk (FAR)
```{r}
# Here is the FAR function

FAR <- function(R_nat, R_real, threshold){
  
  n = length(threshold)
  
  res = rep(NA, n)
  for (k in 1:n){
    p0 = sum(R_nat>=threshold[k]) / length(R_nat)
    p1 = sum(R_real>=threshold[k])/ length(R_real)
    
    res[k] = 1 - p0/p1
  }
    
  return (res)
  
}
```


```{r}
# FAR for temperature

load("~/Documents/LSCE/SWG/tmean_48_50_N_01_04_E_1979_2017.RData")
dat = tmean[,1]

DATE = atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

Seq_nat  = dat[DATE$Y>=1979 & DATE$Y<=1997]   # 1979 - 1997 
Seq_real = dat[DATE$Y>=1998 & DATE$Y<=2017]   # 1998 - 2017
  
# FAR(R_nat = Seq_nat, R_real = Seq_real, threshold = 20)

x = seq(from = 20, to = min(max(Seq_nat), max(Seq_real)), by = 0.1)
plot(x, FAR(Seq_nat, Seq_real, x), type = "l", ylab = "FAR", xlab = "°C")

```

# For precipitation
## Predictor - Sea level pressure (ERA-Interim)
```{r, eval=F}
nc <- nc_open("~/Documents/LSCE/nc/slp.1979-2017_NA.nc")
print(nc)
data = ncvar_get(nc, "msl") 
LON = ncvar_get(nc, "longitude")
LAT = ncvar_get(nc, "latitude")
time = ncvar_get(nc, "time")
nc_close(nc)

# LON = LON[which(LON>=-5.25 & LON<=15.00)]
# LAT = LAT[which(LAT<=55.50 & LAT>=34.50)]

# data = data[which(LON>=-5.25 & LON<=15.00), which(LAT<=55.50 & LAT>=34.50),]

nlon = length(LON)
nlat = length(LAT)
nt = length(time)

dat = data*NA; dim(dat) <- c(nt, nlat, nlon)
dim(dat)

for (i in 1:nt){ 
  dat[i,,] = t(data[,,i]) 
}
dim(dat) = c(nt, nlat*nlon)

pond = 1/sqrt(cos(LAT*pi/180))
scale = rep(pond, length(LON))

w_dat = dat*NA
for(pix in 1:ncol(w_dat)){
  w_dat[,pix] = dat[,pix]/scale[pix]
}

SEAS=c('DJF','MAM','JJA','SON')
DATE_ERAI = atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

pca = prcomp(w_dat[DATE_ERAI$m%in%c(12,1,2), ], retx = T, scale = T)
search.PCAlevel(pca, 90)
PCS = as.data.frame(pca$x)
save(PCS, file = paste0("~/Documents/LSCE/SWG/tp/slp_", SEAS[1], "_PCS.RData"))

pca = prcomp(w_dat[DATE_ERAI$m%in%c(3,4,5), ], retx = T, scale = T)
search.PCAlevel(pca, 90)
PCS = as.data.frame(pca$x)
save(PCS, file = paste0("~/Documents/LSCE/SWG/tp/slp_", SEAS[2], "_PCS.RData"))

pca = prcomp(w_dat[DATE_ERAI$m%in%c(6,7,8), ], retx = T, scale = T)
search.PCAlevel(pca, 90)
PCS = as.data.frame(pca$x)
save(PCS, file = paste0("~/Documents/LSCE/SWG/tp/slp_", SEAS[3], "_PCS.RData"))

pca = prcomp(w_dat[DATE_ERAI$m%in%c(9,10,11), ], retx = T, scale = T)
search.PCAlevel(pca, 90)
PCS = as.data.frame(pca$x)
save(PCS, file = paste0("~/Documents/LSCE/SWG/tp/slp_", SEAS[4], "_PCS.RData"))
```

## Precipitation data (E-OBS)
```{r, eval=FALSE}
filenames = list.files("~/Documents/LSCE/precip_47_51_N_10_15_E/")
nc <- nc_open("~/Documents/LSCE/precip_47_51_N_10_15_E/igridensembles_05_rr_0010.25_047.25_n.nc")
print(nc)
data = ncvar_get(nc, "rr")
sum(is.na(data))
range(data[!is.na(data)])
time = ncvar_get(nc, "time")

time = as.Date(1:24957, origin = "1949-12-31")
nt = length(time)
nc_close(nc)

lon = seq(from = 10.25, to = 14.75, by = 0.5); nx = length(lon)
lat = seq(from = 47.25, to = 50.75, by = 0.5); ny = length(lat)
coord_grid = as.data.frame(matrix(NA, nrow = nx*ny, ncol = 2))
colnames(coord_grid) = c("lon", "lat")
coord_grid$lon = rep(lon, each = ny)
coord_grid$lat = rep(lat, n = nx)

data = as.data.frame(matrix(NA, nrow = nt, ncol = nx*ny))
rownames(data) = time
for (k in 1:(nx*ny)){
  nc <- nc_open(paste0("~/Documents/LSCE/precip_47_51_N_10_15_E/igridensembles_05_rr_00", coord_grid[k,1], "_0", coord_grid[k,2], "_n.nc"))
  data[,k] = ncvar_get(nc, "rr")[1:nt]
  nc_close(nc)
}

precip = as.data.frame(apply(data, MARGIN = 1, FUN = mean))
colnames(precip) = c("precip")
range(precip)
save(precip, file = "~/Documents/LSCE/SWG/precip_47_51_N_10_15_E.RData")

which(rownames(precip) == "1979-01-01")
which(rownames(precip) == "2017-12-31")
precip = precip[which(rownames(precip) == "1979-01-01"):which(rownames(precip) == "2017-12-31"),]
precip = as.data.frame(precip)
rownames(precip) = time[which(time=="1979-01-01"):which(time=="2017-12-31")]
save(precip, file = "~/Documents/LSCE/SWG/precip_47_51_N_10_15_E_1979_2017.RData")
```

## Estimation parameters 
```{r, eval=FALSE}
threshocc=0
threshfall=0
thresh_name=0
MON=c(12,1:11)
MON=matrix(MON,nrow=4,ncol=3,byrow=T)
SEAS=c('DJF','MAM','JJA','SON')
season=c('Winter','Spring','Summer','Fall')

DATE_OBS = atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

for (seas in 1:4){
  # seas = 1
  cat(season[seas],'\n')
  
  DATE_ERAI = atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))
  idxdates=which(DATE_ERAI['m']==MON[seas,1] | DATE_ERAI['m']==MON[seas,2] | DATE_ERAI['m']==MON[seas,3])
  DATE_ERAI=DATE_ERAI[idxdates,]
  
  load(paste("~/Documents/LSCE/SWG/tp/slp_",SEAS[seas],"_PCS.RData",sep=""))
  PCS = PCS[,1:20]
  
  load("~/Documents/LSCE/SWG/precip_47_51_N_10_15_E_1979_2017.RData")
  dat = precip
  
  NB_STATION = 1
  
  idx_control_dates = which((DATE_ERAI['Y']>=1979) & (DATE_ERAI['Y']<=2004))  # from 1979 to 2004 total 26 years
  idx_proj_dates    = which((DATE_ERAI['Y']>=2005) & (DATE_ERAI['Y']<=2017))  # 2005 - 2017
  
  DATECALIB = DATE_ERAI[idx_control_dates,]
  DATEPROJ  = DATE_ERAI[idx_proj_dates,]
  
  PCS=PCS[idx_control_dates,]
  pc_name=names(PCS)
  
  # cherche les indices de jour dans DATE_ECA qui correspondent aux dates ERAI pour la période de calibration
  idx_dates=array(0,dim=length(idx_control_dates))
  for (i in 1:length(idx_control_dates)){
    idx_dates[i]=which(((DATE_OBS['Y'])[,1]==(DATE_ERAI['Y'])[idx_control_dates[i],1])
                       & ((DATE_OBS['m'])[,1]==(DATE_ERAI['m'])[idx_control_dates[i],1])
                       & ((DATE_OBS['d'])[,1]==(DATE_ERAI['d'])[idx_control_dates[i],1]))
  } # end for i
  
  
  ######## Rain occurence, logistic regression,vglm ######
  fmlaro = as.formula(paste("RO ~ ", paste(pc_name, collapse= "+")))
  fit_stations_ro = vector("list", NB_STATION)
  statio_pix_ro = array(NaN, NB_STATION)
  
  for (i in 1:NB_STATION){
    
    idx1 = which(dat[idx_dates,i] > threshocc) ### & stations_eca_precip[idx_dates,i]<1000
    if(length(idx1)<2){
      fit_stations_ro[[i]]=NaN
    }
    
    if(length(idx1)>=2){    
      rain_occur=array(0,dim=length(idx_dates))
      rain_occur[idx1]=1
      ro=data.frame(RO=rain_occur,PCS)
      
      fit_stations_ro[[i]]=try(vglm(fmlaro ,binomialff(multiple.responses=TRUE), data=ro, x.arg= FALSE, y.arg= FALSE, qr.arg = FALSE),silent=F)
    
      if(length(slotNames(fit_stations_ro[[i]]))==0){
        fit_stations_ro[[i]] = length(which(stations_claris_precip[idx_dates,i] > threshocc))/length(stations_claris_precip[idx_dates,i])
        statio_pix_ro[i]='statio'
      }
      
      if(length(slotNames(fit_stations_ro[[i]]))!=0){
        if(length(slotNames(fit_stations_ro[[i]]))>0 & is.finite(fit_stations_ro[[i]]@criterion$loglikelihood)!=TRUE){
          fit_stations_ro[[i]] = length(which(dat[idx_dates,i] > threshocc))/length(dat[idx_dates,i])
          statio_pix_ro[i]='statio'
        } # end if
      } # end if length(slotNames...) != 0
      
    } # end if length idx1 >= 2
    
  } # end for i NB__STATION

  
  ############## Rainfall amounts, gamma distribution, vglm
  
  fmlarf = as.formula(paste("RF ~ ",paste(pc_name, collapse= "+")))
  fit_stations_rf <- vector("list", NB_STATION)
  statio_pix_rf<- array(NaN, NB_STATION)
  
  for (i in 1:NB_STATION){
    
    idx1 = which(dat[idx_dates,i] > threshfall) ### & stations_claris_precip[idx_dates,i]<1000
    
    if(length(idx1)<2){
      fit_stations_rf[[i]]=NaN
    }
    
    if(length(idx1)>=2){    
      
      rain=dat[idx_dates[idx1],i]
      rf=data.frame(RF=rain,PCS[idx1,])
      
      fit_stations_rf[[i]] = try(vgam(fmlarf ,gammaR(zero=NULL), data=rf,maxit=1000, x.arg= FALSE, y.arg= FALSE, qr.arg = FALSE),silent=T)#, trace = TRUE, crit="c"
      
      if(length(slotNames(fit_stations_rf[[i]]))==0){
        fit_stations_rf[[i]] = try(vgam(rain~1 ,gammaR(zero=NULL), data=rf,maxit=1000, x.arg= FALSE, y.arg= FALSE, qr.arg = FALSE),silent=T)
        statio_pix_rf[i]='statio'
      }
      if(length(slotNames(fit_stations_rf[[i]]))!=0){
        if(length(slotNames(fit_stations_rf[[i]]))>0 & is.finite(fit_stations_rf[[i]]@criterion$loglikelihood)!=TRUE){
          fit_stations_rf[[i]] = try(vgam(rain~1 ,gammaR(zero=NULL), data=rf,maxit=1000, x.arg= FALSE, y.arg= FALSE, qr.arg = FALSE),silent=T)
          statio_pix_rf[i]='statio'
        }
      }	
    }
    
    cat("station ",i,": \n")
    warnings()
    
    
  } # end for i
  
  cat(which(statio_pix_ro=='statio'),'\n')
  cat(which(statio_pix_rf=='statio'),'\n')
  a=date()
  cat(a,'\n')
  
  # Nom du fichier de sortie en RData
  filename=paste('~/Documents/LSCE/SWG/SWG_ERAI_ESD_precip_',season[seas],'_cross-val.RData',sep="")
  cat(filename,'\n')
  save(statio_pix_ro,fit_stations_ro,statio_pix_rf,fit_stations_rf, file = filename)
  
} # end for seas
```

## Simulation (P1, sharp, rate)
```{r, eval=FALSE}
DATE_ERAI= atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

DATE_proj = atoms(timeSequence(from="2005-01-01",to="2017-12-31",by='day'))
LENGTH_proj = dim(atoms(timeSequence(from="2005-01-01",to="2017-12-31",by='day')))[1]

P1 = array(NaN,c(LENGTH_proj,1)) # matrice de probas d'occurrence
shape = array(NaN,c(LENGTH_proj,1))
rate = array(NaN,c(LENGTH_proj,1))

DATE_OBS= atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

MON=c(12,1:11)
MON=matrix(MON,nrow=4,ncol=3,byrow=T)
SEAS=c('DJF','MAM','JJA','SON')
season=c('Winter','Spring','Summer','Fall')

for (seas in 1:4){
  # seas = 1
  cat(season[seas],'\n')
  
  DATE_ERAI= atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))
  idxdates=which(DATE_ERAI['m']==MON[seas,1] | DATE_ERAI['m']==MON[seas,2] | DATE_ERAI['m']==MON[seas,3])
  DATE_ERAI=DATE_ERAI[idxdates,]
  
  idx_proj_dates = which( (DATE_ERAI['Y']>=2005) & (DATE_ERAI['Y']<=2017) )    # 2005 - 2017
  
  load(paste("~/Documents/LSCE/SWG/tp/slp_",SEAS[seas],"_PCS.RData",sep=""))
  
  PCS=PCS[idx_proj_dates,1:20]
  NB_pred=dim(PCS)[2]
  
  
  # Nom du fichier sauvegardé contenant les estimations
  filename=paste('~/Documents/LSCE/SWG/SWG_ERAI_ESD_precip_',season[seas],'_cross-val.RData',sep="")
  load(filename)
  
  tempP1 = array(NaN,c(length(idx_proj_dates),length(fit_stations_ro)))
  tempshape = array(NaN,c(length(idx_proj_dates),length(fit_stations_ro)))
  temprate = array(NaN,c(length(idx_proj_dates),length(fit_stations_ro)))
  
  slot=array(NA,length(fit_stations_rf))
  
  for (i in 1:length(fit_stations_rf)){
    slot[i]=length(slotNames(fit_stations_rf[[i]]))
  }
  idx = which(slot>0)
  
  for (k in idx){
    
    ## occurrence
    if(statio_pix_ro[[k]]=='statio'){
      par_ro=fit_stations_ro[[k]]
      temp=par_ro[1]
      tempP1[,k] = replicate(length(idx_proj_dates),temp)
    }
    
    if(statio_pix_ro[[k]]!='statio'){
      par_ro = coef(fit_stations_ro[[k]],matrix=T)
      temp = par_ro[1] + as.matrix(PCS[,1:(NB_pred)])%*%as.matrix(par_ro[2:(NB_pred+1)])
      tempP1[,k] = exp(temp)/(1+exp(temp))
    }
    
    
    #intensity
    par_rf=coef(fit_stations_rf[[k]],matrix=T)
    if(statio_pix_rf[[k]]=='statio'){
      temp2 =par_rf
      tempshape[,k] =replicate(length(idx_proj_dates),exp (temp2[2]))
      temprate[,k] = replicate(length(idx_proj_dates),exp (temp2[1]))
    }
    
    if(statio_pix_rf[[k]]!='statio'){
      tempshape[,k] = exp(par_rf[1,2] + as.matrix(PCS[,1:(NB_pred)])%*%as.matrix(par_rf[2:(NB_pred+1),2]))
      temprate[,k] = exp(par_rf[1,1] + as.matrix(PCS[,1:(NB_pred)])%*%as.matrix(par_rf[2:(NB_pred+1),1]))
    }
    
  } # end for k
  
  td = which(DATE_OBS$Y==2005)[1]-1
  
  P1[(idxdates[idx_proj_dates] - td),] = tempP1       ; cat(range(tempP1),    "\n")
  shape[(idxdates[idx_proj_dates] - td),] = tempshape ; cat(range(tempshape), "\n")
  rate[(idxdates[idx_proj_dates] - td),] = temprate   ; cat(range(temprate),  "\n")
  
} # end for seas

save(P1, shape, rate, file = "~/Documents/LSCE/SWG/precip_P1_shape_rate.RData")
```

## Sampling with Gamma distribution
```{r, eval=FALSE}
load("~/Documents/LSCE/SWG/precip_P1_shape_rate.RData")

DATE = atoms(timeSequence(from="2005-01-01",to="2017-12-31",by='day'))

Sample_binomocc_gammaity<- function(par_ro,par_rf1,par_rf2,thresh=0){
  a=date()
  cat(a,'\n')
  
  Nb_stations=dim(par_ro)[2]
  echant=array(NaN,dim=dim(par_ro))
  for (station in 1:Nb_stations){
    simul_pluie=runif(dim(par_ro)[1],0,1)
    for (j in 1:(dim(par_ro)[1])){
      if (simul_pluie[j]<par_ro[j,station]){
        p=runif(1)
        C=pgamma(thresh,shape=par_rf1[j,station],scale=1/par_rf2[j,station])
        echant[j,station]=qgamma(p*(1-C)+C,shape=par_rf1[j,station],scale=1/par_rf2[j,station])
      }
      else {echant[j,station]=0}
    }
  }
  a=date()
  cat(a,'\n')
  return(echant)
}

idx = 1
for(i in 1:100){
  
  NUM=cbind(formatC(i, digits = 0, width = 3, format = "f", flag = "0"))
  cat('Run',NUM,'\n')
  
  Sample_temp = Sample_binomocc_gammaity(P1,shape,rate)
  Sample=array(NaN,dim=dim(P1))
  Sample[,idx]=Sample_temp
  
  Sample=round(Sample,digits=2)
  
  filesimu = paste('~/Documents/LSCE/SWG/SIMU_precip/SIMU_SWG_precip', '_run_', NUM, '.RData', sep="")
  save(Sample,DATE,file = filesimu)
  
}
```

## Diagnosis - distribution
```{r}
## validation period: 2005 - 2017
time = as.Date(1:4748, origin = "2004-12-31")
range(time)

load("~/Documents/LSCE/SWG/precip_47_51_N_10_15_E_1979_2017.RData")
Obs = precip[which(rownames(precip)=="2005-01-01"):which(rownames(precip)=="2017-12-31"),]
plot(x = time, y = Obs)
range(Obs)   # 0.0000 36.0525

load("~/Documents/LSCE/SWG/SIMU_precip/SIMU_SWG_precip_run_026.RData")   # 19,26,88
Sample = Sample[,1]
plot(x = time, y = Sample)
range(Sample)

# hist(Obs)
# hist(Sample)
# qqplot
## qqplot
qqplot(Obs, Sample, xlab = "obs", ylab = "sim", pch = 20,
       main = "precip", cex.main = 1.5, cex.lab = 1, 
       xlim = c(min(c(Obs, Sample)), max(c(Obs, Sample))),
       ylim = c(min(c(Obs, Sample)), max(c(Obs, Sample))))
abline(0,1,col="red")
```

```{r}
res <- CramerVonMisesTwoSamples(Sample, Obs)
pvalue = 1/6*exp(-res)
pvalue
```

## Diagnosis - temporal correlation
```{r}
load("~/Documents/LSCE/SWG/precip_47_51_N_10_15_E_1979_2017.RData")   

Obs = precip[which(rownames(precip)=="2005-01-01"):which(rownames(precip)=="2017-12-31"),]

k = 1 
NUM=cbind(formatC(k, digits = 0, width = 3, format = "f", flag = "0"))
  
load(paste0("~/Documents/LSCE/SWG/SIMU_precip/SIMU_SWG_precip_run_", NUM, ".RData"))
Sample = Sample[,1]

# set number of lag
nlag = 31

# data_acf contains acf_obs and acf_sim
data_acf = as.data.frame(matrix(data = NA, nrow = 2*nlag, ncol = 3))

acf_obs = acf(Obs, plot = F, lag.max = nlag-1)
acf_obs = with(acf_obs, data.frame(lag, acf))
acf_obs = acf_obs[-1,]
acf_sim = acf(Sample, plot = F, lag.max = nlag-1)
acf_sim = with(acf_sim, data.frame(lag, acf))
acf_sim = acf_sim[-1,]
data_acf = rbind(acf_obs, acf_sim)
data_acf$type = c(rep("obs", nlag-1), rep("sim", nlag-1))

color = c("black", "red")
{
  p = ggplot(data = data_acf, mapping = aes(x = lag, y = acf))
  p = p + geom_bar(stat = "identity", aes(fill = type), position = "dodge")
  p = p + scale_fill_manual(values = color)
  p = p + xlab("day")
  p = p + ggtitle(paste0("acf - Obs vs Sample_", k))
  print(p)
}
```

## FAR for precipitation
```{r}
load("~/Documents/LSCE/SWG/precip_47_51_N_10_15_E_1979_2017.RData")
dat = precip[,1]

DATE = atoms(timeSequence(from="1979-01-01",to="2017-12-31",by='day'))

Seq_nat  = dat[DATE$Y>=1979 & DATE$Y<=1997]   # 1979 - 1997 
Seq_real = dat[DATE$Y>=1998 & DATE$Y<=2017]   # 1998 - 2017
  
# FAR(R_nat = Seq_nat, R_real = Seq_real, threshold = 20)

x = seq(from = 20, to = min(max(Seq_nat), max(Seq_real)), by = 0.1)
plot(x, FAR(Seq_nat, Seq_real, x), type = "l", ylab = "FAR", xlab = "mm")

```

